/**
 * @copyright MAGIX CMS Copyright (c) 2008-2026 Gerits Aurelien
 * @version 2.2 (Final - Sanitized & Destructible)
 * @name MagixMaps
 * @license Dual licensed under the MIT or GPL Version 3 licenses.
 */
class MagixMaps{constructor(e){this.config={mapId:"main-map",googleMapId:"DEMO_MAP_ID",lang:"fr",zoom:15,markers:[],adminFields:null,...e},this.sanitizeData(),this.instance=null,this.libs={},this.markers=[],this.routeFlags=[],this.directionsRenderer=null,this.activeInfoWindow=null,this.timer=null,this.eventListeners=[],this.bootstrap()}sanitizeData(){this.config.markers&&Array.isArray(this.config.markers)&&(this.config.markers=this.config.markers.map((e=>{const t=parseFloat(String(e.lat).replace(",",".")),s=parseFloat(String(e.lng).replace(",","."));return{...e,lat:t,lng:s}})).filter((e=>!isNaN(e.lat)&&!isNaN(e.lng))),0!==this.config.markers.length||this.config.adminFields||console.warn("MagixMaps: Aucun marqueur valide trouvé."))}bootstrap(){var e,t,s,i,n,o,r,a,c,l,d,h,m;e={key:this.config.api_key,v:"weekly",lang:this.config.lang},n="The Google Maps JavaScript API",o="google",r="importLibrary",a="__ib__",c=document,l=window,d=(l=l[o]||(l[o]={})).maps||(l.maps={}),h=new Set,m=new URLSearchParams,d[r]?console.warn(n+" only loads once. Ignoring:",e):d[r]=(l,...g)=>h.add(l)&&(t||(t=new Promise((async(r,l)=>{for(i in await(s=c.createElement("script")),m.set("libraries",[...h]+""),e)m.set(i.replace(/[A-Z]/g,(e=>"_"+e[0].toLowerCase())),e[i]);m.set("callback",o+".maps."+a),s.src=`https://maps.${o}apis.com/maps/api/js?`+m,d[a]=r,s.onerror=()=>t=l(Error(n+" could not load.")),s.nonce=c.querySelector("script[nonce]")?.nonce||"",c.head.append(s)})))).then((()=>d[r](l,...g))),this.init()}async init(){try{this.libs.maps=await google.maps.importLibrary("maps"),this.libs.marker=await google.maps.importLibrary("marker"),this.libs.routes=await google.maps.importLibrary("routes"),this.libs.geocoding=await google.maps.importLibrary("geocoding"),this.libs.core=await google.maps.importLibrary("core"),document.getElementById(this.config.mapId)&&this.setupMap(),this.config.adminFields&&this.setupAdminWatcher()}catch(e){console.error("MagixMaps Error:",e)}}setupMap(){const e=document.getElementById(this.config.mapId),t={zoom:this.config.zoom,center:this.config.markers[0]?{lat:this.config.markers[0].lat,lng:this.config.markers[0].lng}:{lat:48.85,lng:2.35},mapId:e.dataset.mapId||this.config.googleMapId,mapTypeControl:!0,streetViewControl:!0};this.instance=new this.libs.maps.Map(e,t),this.renderMarkers(),this.setupUIEvents()}renderMarkers(){const e=new this.libs.core.LatLngBounds;this.config.markers.forEach(((t,s)=>{const i={lat:t.lat,lng:t.lng},n=new this.libs.marker.AdvancedMarkerElement({map:this.instance,position:i,title:t.company,content:this.createMarkerIcon(s+1)}),o=t.postcode?t.postcode+" ":"",r=`<strong>${t.company}</strong><br>${t.address}<br>${o}${t.city}`,a=new google.maps.InfoWindow({content:r});n.addListener("click",(()=>{this.activeInfoWindow&&this.activeInfoWindow.close(),a.open({map:this.instance,anchor:n}),this.activeInfoWindow=a,this.updateAddressPanel(t)})),this.markers.push(n),e.extend(i)})),this.markers.length>1?this.instance.fitBounds(e):1===this.markers.length&&(this.instance.setCenter(this.markers[0].position),this.instance.setZoom(this.config.zoom)),this.config.markers.length>0&&(this.updateAddressPanel(this.config.markers[0]),google.maps.event.trigger(this.markers[0],"click"))}createMarkerIcon(e,t="main"){const s=document.createElement("div");s.className="marker-custom-wrapper";const i=`/${this.config.lang}/gmap/?marker=${t}&dotless=true`;return s.innerHTML=`\n            <img src="${i}" style="display:block;">\n            <span class="marker-label" style="position:absolute; top:12px; left:50%; transform:translateX(-50%); color:white; font-weight:bold; font-size:12px;">${e}</span>\n        `,s}async calculateRoute(e){if(!e)return;const t=new this.libs.routes.DirectionsService;this.routeFlags&&this.routeFlags.forEach((e=>e.map=null)),this.routeFlags=[],this.directionsRenderer||(this.directionsRenderer=new this.libs.routes.DirectionsRenderer({map:this.instance,panel:document.getElementById("r-directions"),suppressMarkers:!0}));try{const s=await t.route({origin:e,destination:this.markers[0].position,travelMode:google.maps.TravelMode.DRIVING});this.directionsRenderer.setDirections(s);const i=s.routes[0].legs[0],n=new this.libs.marker.AdvancedMarkerElement({map:this.instance,position:i.start_location,content:this.createMarkerIcon("A","grey")}),o=new this.libs.marker.AdvancedMarkerElement({map:this.instance,position:i.end_location,content:this.createMarkerIcon("B","main")});this.routeFlags.push(n,o);const r=new this.libs.core.LatLngBounds;r.extend(i.start_location),r.extend(i.end_location),this.instance.fitBounds(r),document.getElementById("r-directions").classList.add("sizedirection")}catch(e){alert("Itinéraire introuvable.")}}setupUIEvents(){const e=document.querySelector(".hidepanel");if(e){const t=()=>{document.getElementById("gmap-address").classList.toggle("open"),e.classList.toggle("open")};e.addEventListener("click",t),this.eventListeners.push({el:e,ev:"click",fn:t})}const t=document.querySelector(".form-search");if(t){const e=e=>{e.preventDefault();const t=document.getElementById("getadress").value;this.calculateRoute(t)};t.addEventListener("submit",e),this.eventListeners.push({el:t,ev:"submit",fn:e})}}updateAddressPanel(e){const t=document.querySelector("#address .address"),s=document.querySelector("#address .city");if(t&&(t.textContent=e.address||""),s){const t=e.postcode?e.postcode+" ":"";s.textContent=t+(e.city||"")}}setupAdminWatcher(){const e=this.config.adminFields;[e.street,e.postcode,e.city,e.country].filter((e=>void 0!==e)).forEach((e=>{const t=()=>this.debounceGeocode();["keyup","change","focusout"].forEach((s=>{e.addEventListener(s,t),this.eventListeners.push({el:e,ev:s,fn:t})}))}))}debounceGeocode(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout((async()=>{const e=this.config.adminFields,t=`${e.street.value}, ${e.postcode.value} ${e.city.value}, ${e.country?e.country.value:""}`;if(t.length<10)return;const s=new this.libs.geocoding.Geocoder;try{const{results:i}=await s.geocode({address:t});if(i&&i[0]){const t=i[0].geometry.location;e.lat.value=t.lat(),e.lng.value=t.lng(),e.lat.style.backgroundColor="#d4edda",setTimeout((()=>e.lat.style.backgroundColor=""),500)}}catch(e){console.warn("Geocoding failed")}}),1e3)}destroy(){console.log("MagixMaps: Destruction de l'instance..."),this.timer&&clearTimeout(this.timer),this.markers.forEach((e=>e.map=null)),this.routeFlags.forEach((e=>e.map=null)),this.markers=[],this.routeFlags=[],this.activeInfoWindow&&this.activeInfoWindow.close(),this.directionsRenderer&&this.directionsRenderer.setMap(null),this.eventListeners.forEach((e=>{e.el.removeEventListener(e.ev,e.fn)}));const e=document.getElementById(this.config.mapId);e&&(e.innerHTML=""),this.instance=null}}