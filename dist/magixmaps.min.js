/**
 * @copyright MAGIX CMS Copyright (c) 2008-2026 Gerits Aurelien
 * @version 2.0
 * @name MagixMaps
 * @license Dual licensed under the MIT or GPL Version 3 licenses.
 */
class MagixMaps{constructor(e){this.config={mapId:"main-map",googleMapId:"DEMO_MAP_ID",lang:"fr",zoom:15,markers:[],adminFields:null,...e},this.instance=null,this.libs={},this.markers=[],this.directionsRenderer=null,this.activeInfoWindow=null,this.timer=null,this.bootstrap()}bootstrap(){var e,t,s,o,n,i,a,r,c,l,d,m,h;e={key:this.config.api_key,v:"weekly",lang:this.config.lang},n="The Google Maps JavaScript API",i="google",a="importLibrary",r="__ib__",c=document,l=window,d=(l=l[i]||(l[i]={})).maps||(l.maps={}),m=new Set,h=new URLSearchParams,d[a]?console.warn(n+" only loads once. Ignoring:",e):d[a]=(l,...p)=>m.add(l)&&(t||(t=new Promise((async(a,l)=>{for(o in await(s=c.createElement("script")),h.set("libraries",[...m]+""),e)h.set(o.replace(/[A-Z]/g,(e=>"_"+e[0].toLowerCase())),e[o]);h.set("callback",i+".maps."+r),s.src=`https://maps.${i}apis.com/maps/api/js?`+h,d[r]=a,s.onerror=()=>t=l(Error(n+" could not load.")),s.nonce=c.querySelector("script[nonce]")?.nonce||"",c.head.append(s)})))).then((()=>d[a](l,...p))),this.init()}async init(){try{this.libs.maps=await google.maps.importLibrary("maps"),this.libs.marker=await google.maps.importLibrary("marker"),this.libs.routes=await google.maps.importLibrary("routes"),this.libs.geocoding=await google.maps.importLibrary("geocoding"),this.libs.core=await google.maps.importLibrary("core"),document.getElementById(this.config.mapId)&&this.setupMap(),this.config.adminFields&&this.setupAdminWatcher()}catch(e){console.error("MagixMaps Error:",e)}}setupMap(){const e=document.getElementById(this.config.mapId),t={zoom:this.config.zoom,center:this.config.markers[0]?{lat:this.config.markers[0].lat,lng:this.config.markers[0].lng}:{lat:48.85,lng:2.35},mapId:e.dataset.mapId||this.config.googleMapId,mapTypeControl:!0,streetViewControl:!0};this.instance=new this.libs.maps.Map(e,t),this.renderMarkers(),this.setupUIEvents()}renderMarkers(){const e=new this.libs.core.LatLngBounds;this.config.markers.forEach(((t,s)=>{const o={lat:parseFloat(t.lat),lng:parseFloat(t.lng)},n=new this.libs.marker.AdvancedMarkerElement({map:this.instance,position:o,title:t.company,content:this.createMarkerIcon(s+1)}),i=t.postcode?t.postcode+" ":"",a=`<strong>${t.company}</strong><br>${t.address}<br>${i}${t.city}`,r=new google.maps.InfoWindow({content:a});n.addListener("click",(()=>{this.activeInfoWindow&&this.activeInfoWindow.close(),r.open({map:this.instance,anchor:n}),this.activeInfoWindow=r,this.updateAddressPanel(t)})),this.markers.push(n),e.extend(o)})),this.markers.length>1?this.instance.fitBounds(e):1===this.markers.length&&(this.instance.setCenter(this.markers[0].position),this.instance.setZoom(this.config.zoom)),this.config.markers.length>0&&(this.updateAddressPanel(this.config.markers[0]),google.maps.event.trigger(this.markers[0],"click"))}createMarkerIcon(e,t="main"){const s=document.createElement("div");s.className="marker-custom-wrapper";const o=`/${this.config.lang}/gmap/?marker=${t}&dotless=true`;return s.innerHTML=`\n        <img src="${o}" style="display:block;">\n        <span class="marker-label" style="position:absolute; top:12px; left:50%; transform:translateX(-50%); color:white; font-weight:bold; font-size:12px;">${e}</span>\n    `,s}async calculateRoute(e){if(!e)return;const t=new this.libs.routes.DirectionsService;this.routeFlags&&this.routeFlags.forEach((e=>e.map=null)),this.routeFlags=[],this.directionsRenderer||(this.directionsRenderer=new this.libs.routes.DirectionsRenderer({map:this.instance,panel:document.getElementById("r-directions"),suppressMarkers:!0}));try{const s=await t.route({origin:e,destination:this.markers[0].position,travelMode:google.maps.TravelMode.DRIVING});this.directionsRenderer.setDirections(s);const o=s.routes[0].legs[0],n=new this.libs.marker.AdvancedMarkerElement({map:this.instance,position:o.start_location,content:this.createMarkerIcon("A","grey")}),i=new this.libs.marker.AdvancedMarkerElement({map:this.instance,position:o.end_location,content:this.createMarkerIcon("B","main")});this.routeFlags.push(n,i);const a=new this.libs.core.LatLngBounds;a.extend(o.start_location),a.extend(o.end_location),this.instance.fitBounds(a),document.getElementById("r-directions").classList.add("sizedirection")}catch(e){alert("Désolé, nous n'avons pas trouvé d'itinéraire pour cette adresse.")}}setupUIEvents(){const e=document.querySelector(".hidepanel");e&&e.addEventListener("click",(()=>{document.getElementById("gmap-address").classList.toggle("open"),e.classList.toggle("open")}));const t=document.querySelector(".form-search");t&&t.addEventListener("submit",(e=>{e.preventDefault();const t=document.getElementById("getadress").value;this.calculateRoute(t)}))}updateAddressPanel(e){const t=document.querySelector("#address .address"),s=document.querySelector("#address .city");if(t&&(t.textContent=e.address||""),s){const t=e.postcode?e.postcode+" ":"";s.textContent=t+(e.city||"")}}setupAdminWatcher(){const e=this.config.adminFields;[e.street,e.postcode,e.city,e.country].filter((e=>void 0!==e)).forEach((e=>{["keyup","change","focusout"].forEach((t=>{e.addEventListener(t,(()=>this.debounceGeocode()))}))}))}debounceGeocode(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout((async()=>{const e=this.config.adminFields,t=`${e.street.value}, ${e.postcode.value} ${e.city.value}, ${e.country?e.country.value:""}`;if(t.length<10)return;const s=new this.libs.geocoding.Geocoder;try{const{results:o}=await s.geocode({address:t});if(o&&o[0]){const t=o[0].geometry.location;e.lat.value=t.lat(),e.lng.value=t.lng(),e.lat.style.transition="background 0.3s",e.lat.style.backgroundColor="#d4edda",setTimeout((()=>e.lat.style.backgroundColor=""),500)}}catch(e){console.warn("Geocoding failed")}}),1e3)}}